"""
수학 과목 프롬프트 설정

수학 시험지 분석에 사용되는 토픽, 난이도, 실수 유형 등을 관리합니다.
"""

# ============================================================
# 수학 토픽 분류표 (학년별 분리)
# ============================================================

MATH_TOPICS = {
    "중1": """[중1 수학]
- 수와 연산: 소인수분해, 정수와 유리수, 정수와 유리수의 계산
- 문자와 식: 문자의 사용과 식, 일차방정식
- 좌표평면과 그래프: 좌표평면, 정비례와 반비례
- 기본 도형: 점, 선, 면, 각, 위치 관계, 작도와 합동
- 평면도형: 다각형, 원과 부채꼴
- 입체도형: 다면체, 회전체, 입체도형의 겉넓이와 부피
- 통계: 자료의 정리, 자료의 해석""",

    "중2": """[중2 수학]
- 수와 식: 유리수와 순환소수, 단항식의 계산, 다항식의 계산
- 부등식과 연립방정식: 일차부등식, 연립일차방정식
- 일차함수: 일차함수와 그래프, 일차함수와 일차방정식
- 도형의 성질: 삼각형의 성질, 사각형의 성질
- 도형의 닮음: 도형의 닮음, 평행선과 선분의 비, 닮음의 활용
- 확률: 경우의 수, 확률""",

    "중3": """[중3 수학]
- 실수와 그 계산: 제곱근과 실수, 근호를 포함한 식의 계산
- 다항식의 곱셈과 인수분해: 다항식의 곱셈, 인수분해
- 이차방정식: 이차방정식의 풀이, 이차방정식의 활용
- 이차함수: 이차함수와 그래프, 이차함수의 활용
- 삼각비: 삼각비, 삼각비의 활용
- 원의 성질: 원과 직선, 원주각
- 통계: 대푯값과 산포도, 상관관계""",

    "고1": """## 공통 과목

[공통수학1]
- 다항식: 다항식의 연산, 항등식과 나머지정리, 인수분해
- 방정식과 부등식: 복소수, 이차방정식, 이차방정식과 이차함수, 여러 가지 방정식, 여러 가지 부등식
- 경우의 수: 경우의 수와 순열, 조합
- 행렬: 행렬의 뜻, 행렬의 연산

[공통수학2]
- 도형의 방정식: 평면좌표, 직선의 방정식, 원의 방정식, 도형의 이동
- 집합과 명제: 집합의 뜻, 집합의 연산, 명제
- 함수와 그래프: 합성함수와 역함수, 유리함수, 무리함수""",

    "고2": """## 일반 선택 과목

[대수]
- 지수함수와 로그함수: 지수, 로그, 지수함수, 로그함수
- 삼각함수: 삼각함수의 정의, 삼각함수의 그래프, 사인법칙과 코사인법칙
- 수열: 등차수열과 등비수열, 수열의 합, 수학적 귀납법

[미적분I]
- 함수의 극한과 연속: 함수의 극한, 함수의 연속
- 미분: 미분계수와 도함수, 도함수의 활용
- 적분: 부정적분, 정적분, 정적분의 활용

[확률과 통계]
- 경우의 수: 순열과 조합, 이항정리
- 확률: 확률의 뜻과 활용, 조건부 확률
- 통계: 확률분포, 통계적 추정, 모비율 추정""",

    "고3": """## 진로 선택 과목

[미적분II]
- 수열의 극한: 수열의 극한, 급수
- 여러 가지 미분법: 여러 가지 함수의 미분, 합성함수/매개변수/음함수 미분
- 여러 가지 적분법: 치환적분, 부분적분, 정적분의 활용

[기하]
- 이차곡선: 포물선, 타원, 쌍곡선
- 평면벡터: 벡터의 연산, 평면벡터의 성분과 내적
- 공간도형과 공간좌표: 공간도형, 공간좌표""",
}

# 중3 제곱근 분류 주의사항 (중3일 때만 포함)
MATH_MIDDLE3_SQRT_GUIDE = """
⚠️ **중3 제곱근 문제 분류 주의사항 (매우 중요!)**

**제곱근이 나오는 문제의 핵심 개념을 정확히 판단하세요:**

1. **"중3 수학 > 실수와 그 계산"으로 분류해야 하는 경우:**
   - 제곱근의 대소 비교가 주요 목표 (예: √245 vs 14 비교)
   - 근호를 포함한 식의 사칙연산 (예: √2 + √3, √12 ÷ √3)
   - 제곱근의 성질 이용 (예: √a² = |a|, √a × √b = √(ab))
   - 분모의 유리화
   - 제곱근 값 구하기

2. **"중3 수학 > 삼각비"로 분류해야 하는 경우:**
   - 피타고라스 정리가 핵심 (직각삼각형의 변의 길이)
   - 삼각비(sin, cos, tan) 사용
   - 그림자 문제에서 삼각비 적용

3. **도형 단원으로 분류하면 안 되는 경우:**
   - ❌ 단순히 정사각형 넓이에서 제곱근이 나온다고 "도형의 넓이"로 분류 금지
   - ❌ 제곱근 계산이 주요 학습 목표인데 "기하(중)" 분류 금지

**판단 기준:**
- 이 문제를 풀 때 학생이 **가장 중요하게 사용해야 하는 개념**이 무엇인가?
- 제곱근 계산/비교 → 실수와 그 계산
- 피타고라스 정리/삼각비 → 삼각비
- 도형의 성질 → 도형"""


# ============================================================
# 과목명 매칭 규칙 (고등학교 내신용)
# ============================================================

SUBJECT_MATCHING_RULES = """⚠️ **[필수] 과목 추출 및 단일 과목 원칙**

1. **파일명/제목에서 과목 추출**: 시험지 파일명이나 제목에 과목명이 포함되어 있으면 해당 과목만 사용
   - 예: "등문고 2학년 **확률과통계** 23-1-중간" → 모든 문항을 [확률과 통계]로 분류
   - 예: "**공통수학1** 1학기 기말" → 모든 문항을 [공통수학1]로 분류

2. **내신 시험 = 단일 과목**: 고등학교 내신(중간/기말)은 하나의 교재(과목)에서만 출제됨
   - ❌ 잘못된 예: 확률과통계 시험인데 일부 문항을 공통수학1로 분류
   - ✅ 올바른 예: 확률과통계 시험이면 모든 문항을 [확률과 통계]로 분류

3. **예외 - 여러 과목 허용**: 모의고사, 수능, "종합"/"통합" 명시된 경우

4. **과목명 매칭 우선순위**:
   - "확률과 통계", "확률과통계", "확통" → [확률과 통계]
   - "공통수학1", "공수1" → [공통수학1]
   - "공통수학2", "공수2" → [공통수학2]
   - "대수" → [대수]
   - "미적분I", "미적분1" → [미적분I]
   - "미적분II", "미적분2", "미적분" → [미적분II]
   - "기하" → [기하]"""


# ============================================================
# 수학 난이도 시스템
# ============================================================

MATH_DIFFICULTY_SYSTEM_4LEVEL = """🚨 **수학 난이도 4단계 시스템 (엄격 적용)**:

**핵심 원칙: 문제를 푸는데 필요한 사고의 깊이로 판단!**

### 1️⃣ concept (개념) - 기본 개념 직접 적용
- 교과서 개념/정의/공식을 그대로 적용, 1-2단계 풀이
- 정답률 85% 이상 예상
- **서술형도 개념 가능**: 공식을 대입만 하면 되는 풀이

### 2️⃣ pattern (유형) - 알려진 유형/패턴 적용
- 기출/교과서 유제 수준, 2-3개 개념 순차 적용, 3-5단계 풀이
- 정답률 60-85% 예상
- ❌ 단순 공식 대입 → concept / 2개 이상 유형 결합 → reasoning

### 3️⃣ reasoning (심화) - 복합 개념 응용/사고력 필요
- 2-3개 대단원 개념 복합, 5-7단계 이상 풀이
- 정답률 30-60% 예상
- ❌ 계산만 복잡 → pattern / 교과서 예제 → pattern

### 4️⃣ creative (최상위) - 킬러 문제 (극히 제한적!)
- 3개 이상 대단원 복합, 8단계 이상, 교과서 범위를 넘는 창의적 통찰
- 정답률 30% 이하
- **원칙**: 시험당 최대 1문제, 의심스러우면 무조건 reasoning!

**난이도 판정 플로우차트:**
1. 공식만 대입? → concept
2. 알고있는 유형/패턴? → pattern
3. 2개 이상 개념 결합 or 새로운 접근? → reasoning
4. 교과서 범위 밖 창의적 통찰? → creative (극히 드물게!)

**❗ 중요:**
- **서술형이라고 무조건 난이도가 높은 게 아님!**
- **배점이 높다고 자동으로 높은 난이도가 아님!**
- 애매하면 항상 한 단계 낮게!"""


# ============================================================
# 서술형 채점 가이드
# ============================================================

ESSAY_GRADING_GUIDE = """📝 **서술형(essay) 문항 분석 가이드**

**채점 기준표 구조:**
- 풀이 과정: 40-60%
- 최종 답: 30-40%
- 논리적 전개/표현: 10-20%

**4단계 필수 구조:**
| 단계 | 내용 | 배점 비중 |
|------|------|----------|
| 1️⃣ 미지수 설정 | "~을 x라 하면" 명시 | 10-15% |
| 2️⃣ 식 수립 | 조건을 방정식/부등식으로 번역 | 25-35% |
| 3️⃣ 계산 과정 | 단계별 풀이 전개 | 30-40% |
| 4️⃣ 답 도출 | "∴ 답: ~" 형식으로 결론 | 15-25% |

**💡 핵심: "답이 맞아도 과정 생략 시 50% 이상 감점 가능!"**

**감점 요인:**
1. 논리적 비약: 중간 단계 생략, 조건 미확인
2. 형식적 요건: 등호 연속 사용, 단위 미표기, 최종답 미표기
3. 계산 오류: 부호 실수, 괄호 처리, 약분 실수

**시간 배분: 서술형 1문항당 (배점 ÷ 2)분 할당 권장**"""


ESSAY_ANALYSIS_FULL_GUIDE = """📝 **[중요] 서술형(essay) 문항 분석 가이드**

**서술형 문항 채점 기준표 구조 이해:**
- 풀이 과정 점수: 전체 배점의 40-60%
- 최종 답 점수: 전체 배점의 30-40%
- 논리적 전개/표현 점수: 전체 배점의 10-20%

**⚠️ 서술형 채점 역설계: 4단계 필수 구조**

채점자는 다음 4단계가 모두 있는지 확인합니다. 어느 단계라도 생략하면 감점!

| 단계 | 내용 | 배점 비중 | 감점 사유 |
|------|------|----------|----------|
| 1️⃣ 미지수 설정 | "~을 x라 하면" 명시 | 10-15% | 미지수 정의 누락 |
| 2️⃣ 식 수립 | 조건을 방정식/부등식으로 번역 | 25-35% | 수식 근거 불명확 |
| 3️⃣ 계산 과정 | 단계별 풀이 전개 | 30-40% | 중간 단계 생략 |
| 4️⃣ 답 도출 | "∴ 답: ~" 형식으로 결론 | 15-25% | 최종 답 미표기 |

**💡 핵심 원칙: "답이 맞아도 과정 생략 시 50% 이상 감점 가능!"**

예시 (좋은 서술형 답안):
```
(미지수 설정) 두 수 중 큰 수를 x라 하면, 작은 수는 (x-3)이다.
(식 수립) 두 수의 합이 17이므로: x + (x-3) = 17
(계산 과정) 2x - 3 = 17
           2x = 20
           x = 10
(답 도출) ∴ 두 수는 10과 7이다.
```

**서술형 오류 유형별 감점 요인:**

1️⃣ **논리적 비약 (Logical Gap)** - 가장 흔한 감점 요인
   - 중간 단계 생략 (예: "따라서" 전에 근거 없음)
   - 조건 미확인 (정의역, 범위 제한 누락)
   - 풀이 순서 뒤바뀜
   - **4단계 중 어느 것이라도 누락**

2️⃣ **형식적 요건 미비** - 감점 누적
   - "=" 기호 연속 사용 오류 (3=x+2=5 식의 나열)
   - 단위 미표기 (길이, 넓이, 확률 등)
   - 근호/분수 미간결화
   - 최종 답 미표기

3️⃣ **계산 오류** - 치명적 감점
   - 부호 실수 (음수 처리, 이항 시 부호)
   - 괄호 처리 오류
   - 약분/통분 실수

**서술형 ai_comment 작성 가이드:**
- 1문장: 핵심 개념/풀이 전략 언급
- 2문장: 감점 주의사항 또는 부분점수 확보 팁
- 예시: "인수분해 후 근 구하기. 풀이 과정 전개 시 동치 기호(⇔) 활용 권장."

**서술형 난이도 판단 특별 규칙:**
- concept: 공식 대입 + 단순 계산만 서술
- pattern: 절차적 풀이가 명확 (2-3단계)
- reasoning: 풀이 전략 스스로 수립 필요, 논리적 설명/증명 포함
- creative: 복합 개념 통합 + 창의적 접근 필수"""


# ============================================================
# 과목별 흔한 실수 유형 (학년별 선택적 포함)
# ============================================================

MATH_COMMON_MISTAKES = {
    "공통수학": """**공통수학1·2 주요 실수:**
- 다항식: 인수분해 시 부호 실수 ((a-b)²에서 -2ab를 +2ab로)
- 부등식: 양변에 음수 곱할 때 부등호 방향 변경 누락
- 방정식: 분모≠0 조건 확인 누락
- 도형의 방정식: 원의 중심 (a,b)를 (-a,-b)로 착각
- 점과 직선 거리: 절댓값 누락""",

    "대수": """**대수(수학I) 주요 실수:**
- 지수/로그: log(a·b)를 log(a)·log(b)로 착각 (가장 흔함)
- 로그 조건: 진수>0, 밑>0 및 ≠1 조건 누락
- 삼각함수: 사분면별 부호 오류, tan 주기를 2π로 착각(정답: π)
- 수열: aₙ과 Sₙ 관계에서 n=1 별도 확인 누락""",

    "미적분I": """**미적분I(수학II) 주요 실수:**
- 극한: 0/0 부정형 인수분해 실수
- 극값: f'(x)=0에서 부호 변화 확인 누락
- 적분: 적분상수 C 누락, 정적분 상한/하한 대입 순서 오류""",

    "확률과통계": """**확률과통계 주요 실수:**
- 순열/조합 구분 실패 (가장 흔함)
- 원순열 (n-1)!, 염주순열 (n-1)!/2 적용 누락
- 여사건: 1에서 빼기 누락
- 조건부확률 P(A|B)와 P(B|A) 혼동""",

    "미적분II_기하": """**미적분II·기하 주요 실수:**
- 미적분II: (aˣ)' = aˣ ln a에서 ln a 누락
- 부분적분: 반복 시 부호(+/-) 번갈아 적용 실수
- 기하: 포물선 초점 좌표 부호 오류, 타원 장축/단축 구분 실패""",

    # 중학교
    "중1": """**중1 주요 실수:**
- 소인수분해: 지수 표기 누락, 1은 소수가 아님 혼동
- 정수와 유리수: 절댓값 개념 혼동, 부호 처리 오류
- 문자와 식: ×, ÷ 기호 생략 규칙, 동류항 묶기 실패
- 일차방정식: 이항 시 부호 변경 누락""",

    "중2": """**중2 주요 실수:**
- 순환소수: 순환마디 시작점 오인, 분수 변환 공식 혼동
- 연립방정식: 소거 시 부호 처리, 대입 후 정리 실수
- 일차함수: 기울기 부호와 그래프 방향 연결 실패
- 닮음: 닮음비와 넓이비 혼동 (넓이비=닮음비²)""",

    "중3": """**중3 주요 실수:**
- 제곱근: √((-3)²)=3 (절댓값!), 분모 유리화 누락
- 인수분해: 완전제곱식 부호, 공통인수 누락
- 이차방정식: 근의 공식 부호, b²-4ac 계산, 중근 처리
- 이차함수: 표준형 변환 시 부호, 축의 방정식 x=p
- 삼각비: 어떤 각 기준인지 혼동, 특수각 값 암기 실패""",
}


# ============================================================
# 중→고 교육과정 연계 (선수학습 부족 진단용)
# ============================================================

PREREQUISITE_MAPPING = """🔗 **중학교 ↔ 고등학교 교육과정 연계 (취약 원인 분석용)**

| 고등학교 취약 단원 | 필요한 중학교 선수 개념 |
|---|---|
| 다항식/인수분해 | 중3 인수분해, 곱셈공식 |
| 방정식/부등식 | 중2 연립방정식, 중3 이차방정식 |
| 함수/그래프 | 중1 좌표평면, 중2 일차함수, 중3 이차함수 |
| 도형의 방정식 | 중3 피타고라스 정리, 원의 성질 |
| 수열 | 중2 규칙성, 중3 등차/등비 개념 |
| 삼각함수 | 중3 삼각비(sin, cos, tan) |
| 확률 | 중2 경우의 수, 중3 확률 기초 |"""


# ============================================================
# 수준별 학습 전략
# ============================================================

SCORE_LEVEL_STRATEGIES = {
    "하위권": {
        "range": "50% 이하",
        "principle": "쉬운 문제 완벽하게 + 기초 개념 복습",
        "strategies": [
            "중학교 연계 개념부터 복습 (특히 연립방정식, 인수분해, 함수 기초)",
            "'개념 노트 + 쉬운 개념서' 조합으로 기초 다지기",
            "1회독: 개념 파악, 2회독: 유형 익히기, 3회독: 완전 이해",
            "쉬운 문제(난이도 하~중) 정답률 90% 이상 목표",
        ],
    },
    "중위권": {
        "range": "60-80%",
        "principle": "기본기 강화 + 유형 완성",
        "strategies": [
            "5단계 학습법: 예습 → 수업 → 복습 → 문제풀이 → 오답관리",
            "최소 10회분 연습 시험지 풀어보기 (시간 재며)",
            "실수 유형 리스트 작성하여 체크리스트로 활용",
            "취약 단원은 개념 재학습 후 유사 문제 10개 이상 풀기",
        ],
    },
    "상위권": {
        "range": "80% 이상",
        "principle": "만점 전략 + 실수 제로",
        "strategies": [
            "고난도 문제(reasoning, creative) 집중 훈련",
            "연계 단원 복합 문제 연습",
            "다양한 풀이법 습득 (특히 시간 절약 풀이)",
            "실수 방지 체크리스트 매 문제마다 확인",
        ],
    },
}


# ============================================================
# 중학교 단원별 핵심 학습 포인트 (학년별 선택적 포함)
# ============================================================

MATH_MIDDLE_STUDY_POINTS = {
    "중1": """### 【중1 수학】

**소인수분해**
- 핵심: 소인수분해 결과 표기법 (2³×3² 형식)
- 흔한 실수: 지수 표기 누락, 1은 소수가 아님 혼동
- 학습 팁: "약수 개수 = (지수+1)들의 곱" 공식 암기

**정수와 유리수**
- 핵심: 부호 처리 (음수×음수=양수, 음수÷양수=음수)
- 흔한 실수: 절댓값 개념 혼동, 수직선에서 크기 비교 오류
- 학습 팁: "부호가 같으면 +, 다르면 -" 규칙 체화

**문자와 식**
- 핵심: 문자를 사용한 식 표현 (일상 → 수학적 번역)
- 흔한 실수: ×, ÷ 기호 생략 규칙, 동류항 묶기 실패
- 학습 팁: "곱셈 기호 생략, 숫자는 문자 앞에" 원칙

**일차방정식**
- 핵심: 등식의 성질 (양변에 같은 연산)
- 흔한 실수: 이항 시 부호 변경 누락, 계수 나누기 실수
- 학습 팁: "이항하면 부호가 바뀐다" 체크 습관""",

    "중2": """### 【중2 수학】

**순환소수**
- 핵심: 순환마디 표기 (0.333...=0.3̇), 분수 변환
- 흔한 실수: 순환마디 시작점 오인, 분수 변환 공식 혼동
- 학습 팁: "순환마디 자릿수 = 분모의 9 개수" 규칙

**연립방정식**
- 핵심: 가감법/대입법 선택, 해의 기하학적 의미 (두 직선 교점)
- 흔한 실수: 소거 시 부호 처리, 대입 후 정리 실수
- 학습 팁: "계수 맞추기 → 부호 확인 → 소거" 3단계

**일차함수**
- 핵심: y=ax+b에서 a(기울기), b(y절편)의 의미
- 흔한 실수: 기울기 부호와 그래프 방향 연결 실패
- 학습 팁: "기울기 양수→우상향, 음수→우하향" 시각화

**도형의 성질**
- 핵심: 삼각형 합동조건 (SSS, SAS, ASA), 사각형 성질
- 흔한 실수: 합동조건 적용 시 대응 순서 오류
- 학습 팁: "조건 3가지 명시적으로 쓰기" 습관

**닮음**
- 핵심: 닮음비, 평행선과 선분비
- 흔한 실수: 닮음비와 넓이비 혼동 (넓이비=닮음비²)
- 학습 팁: "길이비:넓이비:부피비 = 1:2:3승" 관계""",

    "중3": """### 【중3 수학】

**제곱근**
- 핵심: √(a²)=|a| (음수도 고려!), 근호 계산
- 흔한 실수: √((-3)²)=3 (절댓값!), 분모 유리화 누락
- 학습 팁: "제곱근은 항상 양수 또는 0" 원칙

**인수분해**
- 핵심: 공통인수, 곱셈공식 역이용 (a²-b²=(a+b)(a-b))
- 흔한 실수: 완전제곱식 부호, 공통인수 누락
- 학습 팁: "공통인수 먼저 → 곱셈공식 적용" 순서

**이차방정식**
- 핵심: 인수분해/근의 공식 선택, 해 검증
- 흔한 실수: 근의 공식 부호, b²-4ac 계산, 중근 처리
- 학습 팁: "판별식으로 해의 개수 먼저 확인" 습관

**이차함수**
- 핵심: y=a(x-p)²+q 표준형 (꼭짓점 (p,q))
- 흔한 실수: 표준형 변환 시 부호, 축의 방정식 x=p
- 학습 팁: "일반형→표준형 완전제곱식 만들기" 연습

**삼각비**
- 핵심: sin, cos, tan 정의 (대변/빗변, 인접변/빗변, 대변/인접변)
- 흔한 실수: 어떤 각 기준인지 혼동, 특수각 값 암기 실패
- 학습 팁: "SOH-CAH-TOA" 또는 "사코타" 암기법""",
}


# ============================================================
# 헬퍼 함수: 학년에 따라 필요한 토픽만 반환
# ============================================================

def get_topics_for_grade(grade_level: str | None) -> str:
    """학년에 맞는 토픽 분류표만 반환 (토큰 절감)"""
    if not grade_level:
        # 학년 모르면 전체 반환
        middle = "\n\n".join([MATH_TOPICS[g] for g in ["중1", "중2", "중3"]])
        high = "\n\n".join([MATH_TOPICS[g] for g in ["고1", "고2", "고3"]])
        return f"### 【중학교】\n\n{middle}\n\n### 【고등학교 - 2022 개정 교육과정】\n\n{high}"

    # 중학교
    if grade_level.startswith("중"):
        topics = "\n\n".join([MATH_TOPICS[g] for g in ["중1", "중2", "중3"] if g in MATH_TOPICS])
        extra = MATH_MIDDLE3_SQRT_GUIDE if grade_level == "중3" else ""
        return f"### 【중학교】\n\n{extra}\n{topics}"

    # 고등학교
    if grade_level.startswith("고"):
        topics = "\n\n".join([MATH_TOPICS[g] for g in ["고1", "고2", "고3"] if g in MATH_TOPICS])
        return f"### 【고등학교 - 2022 개정 교육과정】\n\n{topics}"

    # 알 수 없는 학년
    middle = "\n\n".join([MATH_TOPICS[g] for g in ["중1", "중2", "중3"]])
    high = "\n\n".join([MATH_TOPICS[g] for g in ["고1", "고2", "고3"]])
    return f"### 【중학교】\n\n{middle}\n\n### 【고등학교 - 2022 개정 교육과정】\n\n{high}"


def get_mistakes_for_grade(grade_level: str | None) -> str:
    """학년에 맞는 실수 유형만 반환"""
    if not grade_level:
        return "\n\n".join(MATH_COMMON_MISTAKES.values())

    parts = []

    if grade_level.startswith("중"):
        # 해당 중학교 학년
        if grade_level in MATH_COMMON_MISTAKES:
            parts.append(MATH_COMMON_MISTAKES[grade_level])
    elif grade_level == "고1":
        parts.append(MATH_COMMON_MISTAKES["공통수학"])
    elif grade_level == "고2":
        parts.append(MATH_COMMON_MISTAKES.get("대수", ""))
        parts.append(MATH_COMMON_MISTAKES.get("미적분I", ""))
        parts.append(MATH_COMMON_MISTAKES.get("확률과통계", ""))
    elif grade_level == "고3":
        parts.append(MATH_COMMON_MISTAKES.get("미적분II_기하", ""))

    return "\n\n".join([p for p in parts if p]) if parts else ""


def get_score_level_strategy(score_percentage: int) -> dict:
    """점수대에 맞는 학습 전략 반환"""
    if score_percentage < 50:
        return SCORE_LEVEL_STRATEGIES["하위권"]
    elif score_percentage < 80:
        return SCORE_LEVEL_STRATEGIES["중위권"]
    else:
        return SCORE_LEVEL_STRATEGIES["상위권"]


def get_essay_guide_if_needed(has_essay: bool) -> str:
    """서술형 문항이 있을 때만 가이드 반환"""
    return ESSAY_GRADING_GUIDE if has_essay else ""


def get_middle_study_points(grade_level: str | None) -> str:
    """중학교 학년에 맞는 학습 포인트만 반환 (고등학교는 빈 문자열)"""
    if not grade_level or not grade_level.startswith("중"):
        return ""

    header = """📚 **[참고] 중학교 단원별 핵심 학습 포인트 (ai_comment 작성 시 활용)**

중학교 시험지 분석 시 각 단원별 핵심 포인트와 흔한 실수를 ai_comment에 반영하세요:

"""
    if grade_level in MATH_MIDDLE_STUDY_POINTS:
        return header + MATH_MIDDLE_STUDY_POINTS[grade_level]

    # 학년 불명 → 전체 포함
    return header + "\n\n".join(MATH_MIDDLE_STUDY_POINTS.values())


def get_prerequisite_if_high_school(grade_level: str | None) -> str:
    """고등학교일 때만 중→고 연계 매핑 반환"""
    if not grade_level or not grade_level.startswith("고"):
        return ""

    return PREREQUISITE_MAPPING + """

**ai_comment 작성 예시:**
- 이차방정식 풀이 오류 → "중3 인수분해 공식 복습 권장"
- 함수 그래프 해석 오류 → "중2 일차함수 개념부터 재확인 필요"
- 삼각함수 오류 → "중3 삼각비(sin, cos, tan) 정의 복습 권장"
"""
