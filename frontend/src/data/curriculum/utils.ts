/**
 * 교육과정 데이터 유틸리티 함수
 */

import { HIGH_SCHOOL_CURRICULUM } from './highSchoolCurriculum';
import { MIDDLE_SCHOOL_CURRICULUM } from './middleSchoolCurriculum';

/**
 * GRADE_CONNECTIONS의 fromTopic → 대단원 직접 매핑 테이블
 * 연계.txt와 교육과정 데이터를 기반으로 정확하게 매핑
 */
const TOPIC_TO_MAJOR_UNIT: Record<string, string> = {
  // ===== 중1-1학기 =====
  // 소인수분해 대단원
  '소인수분해': '소인수분해',
  '거듭제곱': '소인수분해',
  '최대공약수와 최소공배수': '소인수분해',

  // 정수와 유리수 대단원
  '정수의 덧셈과 뺄셈': '정수와 유리수',
  '정수의 곱셈과 나눗셈': '정수와 유리수',
  '유리수의 계산': '정수와 유리수',

  // 문자와 식 대단원
  '문자의 사용': '문자와 식',
  '식의 값': '문자와 식',
  '일차식의 계산': '문자와 식',

  // 일차방정식 대단원
  '등식의 성질': '일차방정식',
  '일차방정식의 풀이': '일차방정식',
  '일차방정식의 활용': '일차방정식',

  // 좌표평면과 그래프 대단원
  '순서쌍과 좌표': '좌표평면과 그래프',
  '그래프의 이해': '좌표평면과 그래프',
  '정비례': '좌표평면과 그래프',
  '반비례': '좌표평면과 그래프',

  // ===== 중1-2학기 =====
  // 기본 도형 대단원
  '점, 선, 면, 각': '기본 도형',
  '위치 관계': '기본 도형',
  '평행선의 성질': '기본 도형',
  '작도': '기본 도형',
  '삼각형의 결정 조건': '기본 도형',
  '삼각형의 합동 조건': '기본 도형',

  // 평면도형 대단원
  '다각형의 내각과 외각': '평면도형',
  '원과 부채꼴': '평면도형',

  // 입체도형 대단원
  '다면체': '입체도형',
  '회전체': '입체도형',
  '입체도형의 겉넓이와 부피': '입체도형',

  // 통계 대단원
  '자료의 정리': '통계',
  '히스토그램과 도수분포다각형': '통계',
  '상대도수': '통계',

  // ===== 중2-1학기 =====
  // 수와 연산 대단원
  '유한소수와 무한소수': '수와 연산',
  '순환소수': '수와 연산',

  // 식의 계산 대단원
  '지수법칙': '식의 계산',
  '단항식의 계산': '식의 계산',
  '다항식의 덧셈과 뺄셈': '식의 계산',
  '다항식의 곱셈': '식의 계산',
  '다항식의 나눗셈': '식의 계산',

  // 부등식 대단원
  '부등식의 성질': '부등식',
  '일차부등식의 풀이': '부등식',
  '일차부등식의 활용': '부등식',
  '연립일차부등식': '부등식',

  // 연립방정식 대단원
  '연립방정식의 풀이': '연립방정식',
  '연립방정식의 활용': '연립방정식',
  '해가 특수한 연립방정식': '연립방정식',

  // 일차함수 대단원
  '일차함수와 그래프': '일차함수',
  '일차함수의 기울기와 절편': '일차함수',
  '일차함수의 식 구하기': '일차함수',
  '일차함수와 일차방정식': '일차함수',
  '두 일차함수의 그래프 관계': '일차함수',
  '연립방정식의 해와 그래프': '일차함수',

  // ===== 중2-2학기 =====
  // 삼각형의 성질 대단원
  '이등변삼각형의 성질': '삼각형의 성질',
  '직각삼각형의 합동': '삼각형의 성질',
  '삼각형의 외심': '삼각형의 성질',
  '삼각형의 내심': '삼각형의 성질',

  // 사각형의 성질 대단원
  '평행사변형의 성질': '사각형의 성질',
  '평행사변형이 되는 조건': '사각형의 성질',
  '여러 가지 사각형': '사각형의 성질',

  // 도형의 닮음 대단원
  '닮음의 뜻과 성질': '도형의 닮음',
  '삼각형의 닮음 조건': '도형의 닮음',
  '닮음비와 넓이비, 부피비': '도형의 닮음',
  '평행선과 선분의 비': '도형의 닮음',
  '삼각형의 중점연결정리': '도형의 닮음',
  '삼각형의 무게중심': '도형의 닮음',

  // 피타고라스 정리 대단원
  '피타고라스 정리': '피타고라스 정리',
  '피타고라스 정리의 활용': '피타고라스 정리',

  // 확률 대단원
  '경우의 수': '확률',
  '확률의 뜻과 성질': '확률',
  '확률의 계산': '확률',

  // ===== 중3-1학기 =====
  // 실수와 그 연산 대단원
  '제곱근의 뜻과 표현': '실수와 그 연산',
  '제곱근의 성질': '실수와 그 연산',
  '무리수와 실수': '실수와 그 연산',
  '실수의 대소 관계': '실수와 그 연산',
  '제곱근의 곱셈과 나눗셈': '실수와 그 연산',
  '제곱근의 덧셈과 뺄셈': '실수와 그 연산',
  '분모의 유리화': '실수와 그 연산',
  '제곱근의 정수 부분과 소수 부분': '실수와 그 연산',

  // 다항식의 곱셈과 인수분해 대단원
  '곱셈 공식': '다항식의 곱셈과 인수분해',
  '곱셈 공식의 변형': '다항식의 곱셈과 인수분해',
  '인수분해의 뜻': '다항식의 곱셈과 인수분해',
  '공통인수를 이용한 인수분해': '다항식의 곱셈과 인수분해',
  '공식을 이용한 인수분해': '다항식의 곱셈과 인수분해',
  '복잡한 식의 인수분해': '다항식의 곱셈과 인수분해',

  // 이차방정식 대단원
  '이차방정식의 풀이 (인수분해)': '이차방정식',
  '이차방정식의 풀이 (제곱근)': '이차방정식',
  '이차방정식의 근의 공식': '이차방정식',
  '이차방정식의 활용': '이차방정식',

  // 이차함수 대단원
  '이차함수 y=ax²의 그래프': '이차함수',
  '이차함수 y=a(x-p)²+q의 그래프': '이차함수',
  '이차함수 y=ax²+bx+c의 그래프': '이차함수',
  '이차함수의 최댓값과 최솟값': '이차함수',
  '이차함수의 식 구하기': '이차함수',

  // ===== 중3-2학기 =====
  // 삼각비 대단원
  '삼각비의 뜻': '삼각비',
  '특수각의 삼각비': '삼각비',
  '예각의 삼각비 사이의 관계': '삼각비',
  '삼각비의 활용 (직각삼각형)': '삼각비',
  '삼각비의 활용 (일반 삼각형)': '삼각비',

  // 원의 성질 대단원
  '원과 현': '원의 성질',
  '원주각': '원의 성질',
  '원주각의 활용': '원의 성질',
  '원과 접선': '원의 성질',
  '원의 접선의 길이': '원의 성질',
  '원과 비례': '원의 성질',

  // 통계 (중3) 대단원
  '대푯값': '통계',
  '분산과 표준편차': '통계',
  '산점도와 상관관계': '통계',
  '산점도': '통계',

  // ===== 공통수학1 (고1-1학기) =====
  // 다항식 대단원
  '다항식의 연산': '다항식',
  '나머지정리': '다항식',
  '인수정리': '다항식',
  '조립제법': '다항식',
  '인수분해 (고등)': '다항식',
  '고차식 인수분해': '다항식',

  // 방정식과 부등식 대단원
  '복소수의 뜻과 연산': '방정식과 부등식',
  '켤레복소수': '방정식과 부등식',
  '이차방정식의 판별식': '방정식과 부등식',
  '근과 계수의 관계': '방정식과 부등식',
  '이차방정식과 이차함수의 관계': '방정식과 부등식',
  '삼차방정식과 사차방정식': '방정식과 부등식',
  '연립이차방정식': '방정식과 부등식',
  '이차부등식': '방정식과 부등식',
  '이차함수의 그래프와 x축의 위치 관계': '방정식과 부등식',
  '절댓값을 포함한 방정식과 부등식': '방정식과 부등식',

  // 경우의 수 대단원
  '합의 법칙과 곱의 법칙': '경우의 수',
  '순열': '경우의 수',
  '조합': '경우의 수',

  // 행렬 대단원
  '행렬의 뜻과 덧셈, 뺄셈': '행렬',
  '행렬의 곱셈': '행렬',
  '역행렬': '행렬',

  // ===== 공통수학2 (고1-2학기) =====
  // 도형의 방정식 대단원
  '두 점 사이의 거리': '도형의 방정식',
  '선분의 내분점과 외분점': '도형의 방정식',
  '삼각형의 무게중심 좌표': '도형의 방정식',
  '직선의 방정식': '도형의 방정식',
  '두 직선의 평행과 수직': '도형의 방정식',
  '두 직선의 위치 관계': '도형의 방정식',
  '점과 직선 사이의 거리': '도형의 방정식',
  '원의 방정식': '도형의 방정식',
  '원과 직선의 위치 관계': '도형의 방정식',
  '원의 접선의 방정식': '도형의 방정식',
  '평행이동': '도형의 방정식',
  '대칭이동': '도형의 방정식',
  '평면좌표': '도형의 방정식',

  // 집합과 명제 대단원
  '집합의 뜻과 표현': '집합과 명제',
  '집합의 포함 관계': '집합과 명제',
  '집합의 연산': '집합과 명제',
  '명제와 조건': '집합과 명제',
  '명제의 역, 이, 대우': '집합과 명제',
  '필요조건과 충분조건': '집합과 명제',
  '절대부등식의 증명': '집합과 명제',
  '산술평균과 기하평균': '집합과 명제',
  '코시-슈바르츠 부등식': '집합과 명제',

  // 함수와 그래프 대단원
  '함수': '함수와 그래프',
  '합성함수': '함수와 그래프',
  '역함수': '함수와 그래프',
  '유리함수': '함수와 그래프',
  '무리함수': '함수와 그래프',
  '일대일함수와 일대일대응': '함수와 그래프',
  '함수의 뜻과 그래프': '함수와 그래프',

  // ===== 대수 (고2) =====
  // 지수와 로그 대단원
  '거듭제곱근': '지수와 로그',
  '지수의 확장': '지수와 로그',
  '지수함수': '지수와 로그',
  '지수함수의 그래프': '지수와 로그',
  '지수방정식과 지수부등식': '지수와 로그',
  '로그의 뜻과 성질': '지수와 로그',
  '상용로그': '지수와 로그',
  '로그함수': '지수와 로그',
  '로그함수의 그래프': '지수와 로그',
  '로그방정식과 로그부등식': '지수와 로그',
  '로그의 밑 변환 공식': '지수와 로그',

  // 삼각함수 대단원
  '호도법': '삼각함수',
  '삼각함수의 뜻': '삼각함수',
  '삼각함수의 그래프': '삼각함수',
  '삼각함수의 성질': '삼각함수',
  '삼각방정식과 삼각부등식': '삼각함수',
  '사인법칙': '삼각함수',
  '코사인법칙': '삼각함수',
  '삼각함수의 덧셈정리': '삼각함수',
  '삼각함수 사이의 관계': '삼각함수',
  '삼각함수의 정의': '삼각함수',
  '삼각형의 넓이': '삼각함수',
  '일반각과 호도법': '삼각함수',

  // 수열 대단원
  '등차수열': '수열',
  '등차수열의 합': '수열',
  '등비수열': '수열',
  '등비수열의 합': '수열',
  '수열의 합과 일반항': '수열',
  '시그마의 성질': '수열',
  '여러 가지 수열의 합': '수열',
  '점화식': '수열',
  '수학적 귀납법': '수열',
  '시그마(Σ)의 성질과 공식': '수열',

  // ===== 미적분Ⅰ (고2) =====
  // 함수의 극한 대단원
  '함수의 극한': '함수의 극한',
  '함수의 극한에 대한 성질': '함수의 극한',
  '함수의 연속': '함수의 극한',
  '연속함수의 성질': '함수의 극한',

  // 미분 대단원
  '미분계수': '미분',
  '도함수': '미분',
  '미분공식': '미분',
  '접선의 방정식': '미분',
  '함수의 증가와 감소': '미분',
  '극대와 극소': '미분',
  '함수의 최대와 최소': '미분',
  '방정식과 부등식에의 활용': '미분',
  '속도와 가속도': '미분',
  '함수의 극대와 극소': '미분',
  '함수의 최댓값과 최솟값': '미분',

  // 적분 대단원
  '부정적분': '적분',
  '정적분': '적분',
  '정적분의 성질': '적분',
  '정적분과 급수': '적분',
  '넓이': '적분',
  '속도와 거리': '적분',
  '정적분과 넓이': '적분',
  '정적분의 정의와 계산': '적분',

  // ===== 확률과 통계 (선택) =====
  // 경우의 수 (확통) 대단원
  '중복순열': '경우의 수',
  '중복조합': '경우의 수',
  '같은 것이 있는 순열': '경우의 수',
  '원순열': '경우의 수',
  '이항정리': '경우의 수',
  '이항계수의 성질': '경우의 수',
  '중복순열과 중복조합': '경우의 수',

  // 확률 (확통) 대단원
  '확률의 뜻': '확률',
  '확률의 덧셈정리': '확률',
  '조건부확률': '확률',
  '확률의 곱셈정리': '확률',
  '독립과 종속': '확률',
  '확률의 뜻과 덧셈정리': '확률',

  // 통계 (확통) 대단원
  '이산확률변수': '통계',
  '이산확률분포': '통계',
  '이항분포': '통계',
  '정규분포': '통계',
  '표본평균의 분포': '통계',
  '모평균의 추정': '통계',
  '상관관계': '통계',
};

/**
 * 키워드 → 대단원 매핑 테이블 생성 (싱글톤)
 * 교육과정 데이터에서 모든 keywords를 추출하여 대단원과 매핑
 */
let keywordToUnitMap: Map<string, string> | null = null;

function buildKeywordToUnitMap(): Map<string, string> {
  if (keywordToUnitMap) return keywordToUnitMap;

  keywordToUnitMap = new Map<string, string>();

  const allCurricula = [...HIGH_SCHOOL_CURRICULUM, ...MIDDLE_SCHOOL_CURRICULUM];

  for (const curriculum of allCurricula) {
    for (const unit of curriculum.units) {
      const unitName = unit.name; // 대단원명

      for (const topic of unit.topics) {
        // 각 keyword를 대단원에 매핑
        for (const keyword of topic.keywords) {
          const normalizedKeyword = keyword.toLowerCase().trim();
          // 이미 있으면 덮어쓰지 않음 (먼저 등록된 것 우선)
          if (!keywordToUnitMap.has(normalizedKeyword)) {
            keywordToUnitMap.set(normalizedKeyword, unitName);
          }
        }
      }
    }
  }

  return keywordToUnitMap;
}

/**
 * 주어진 토픽 문자열에서 대단원을 찾습니다.
 * 1. "대단원 > 소단원" 형식이면 대단원 추출
 * 2. GRADE_CONNECTIONS의 fromTopic 직접 매핑 테이블 확인
 * 3. 교육과정 데이터의 keywords를 검색하여 대단원 반환
 * 4. Fallback: 키워드 기반 분류
 *
 * @param topic 토픽 문자열 (예: "도형의 방정식 > 평면좌표" 또는 "평면좌표")
 * @returns 대단원명 또는 '기타'
 */
export function getMajorUnitFromCurriculum(topic: string): string {
  // 1. "과목 > 대단원 > 소단원" 또는 "대단원 > 소단원" 형태 처리
  const parts = topic.split(' > ');
  if (parts.length >= 2) {
    // 첫 번째 부분이 과목명인지 확인 (공통수학1, 공통수학2, 대수, 미적분 등)
    const subjectNames = ['공통수학1', '공통수학2', '대수', '미적분', '미적분Ⅰ', '미적분Ⅱ', '확률과 통계', '기하'];
    if (subjectNames.includes(parts[0].trim())) {
      // 과목명이면 두 번째 부분이 대단원
      return parts[1]?.trim() || parts[0].trim();
    }
    // 과목명이 아니면 첫 번째 부분이 대단원
    return parts[0].trim();
  }

  // 2. 직접 매핑 테이블에서 찾기 (GRADE_CONNECTIONS fromTopic 기준)
  const trimmedTopic = topic.trim();
  if (TOPIC_TO_MAJOR_UNIT[trimmedTopic]) {
    return TOPIC_TO_MAJOR_UNIT[trimmedTopic];
  }

  // 3. 교육과정 데이터에서 keyword 매칭 시도
  const map = buildKeywordToUnitMap();
  const normalizedTopic = topic.toLowerCase().trim();

  // 정확히 일치하는 keyword 찾기
  if (map.has(normalizedTopic)) {
    return map.get(normalizedTopic)!;
  }

  // 부분 매칭 시도: topic이 keyword를 포함하거나, keyword가 topic을 포함
  for (const [keyword, unitName] of map.entries()) {
    if (normalizedTopic.includes(keyword) || keyword.includes(normalizedTopic)) {
      return unitName;
    }
  }

  // 4. Fallback: 기존 키워드 기반 분류
  const t = topic.toLowerCase();
  if (t.includes('지수') || t.includes('로그')) return '지수와 로그';
  if (t.includes('삼각함수') || t.includes('삼각비') || t.includes('호도법') || t.includes('사인') || t.includes('코사인')) return '삼각함수';
  if (t.includes('수열') || t.includes('급수') || t.includes('점화식') || t.includes('등차') || t.includes('등비')) return '수열';
  if (t.includes('함수') || t.includes('합성') || t.includes('역함수')) return '함수와 그래프';
  if (t.includes('극한') || t.includes('연속')) return '함수의 극한';
  if (t.includes('미분') || t.includes('도함수')) return '미분';
  if (t.includes('적분')) return '적분';
  if (t.includes('확률') || t.includes('순열') || t.includes('조합')) return '경우의 수';
  if (t.includes('벡터')) return '평면벡터';
  if (t.includes('행렬')) return '행렬';
  if (t.includes('방정식') || t.includes('부등식')) return '방정식과 부등식';
  if (t.includes('집합') || t.includes('명제')) return '집합과 명제';
  if (t.includes('다항식') || t.includes('인수분해')) return '다항식';
  if (t.includes('복소수') || t.includes('허수')) return '방정식과 부등식';
  if (t.includes('타원') || t.includes('포물선') || t.includes('쌍곡선')) return '이차곡선';

  return '기타';
}

/**
 * 단원명이 충분히 유사한지 판별 (너무 짧은 부분 문자열 매칭 방지)
 * - 매칭 대상이 2글자 이하면 정확히 일치하거나 "~의", "~와" 등 조사가 붙은 경우만 허용
 * - 3글자 이상이면 부분 문자열 매칭 허용
 */
export function isTopicMatch(topic: string, target: string): boolean {
  const tLower = topic.toLowerCase().trim();
  const gLower = target.toLowerCase().trim();

  // 정확히 일치
  if (tLower === gLower) return true;

  // 짧은 대상(2글자 이하, 예: "실수")은 단어 경계 매칭
  if (gLower.length <= 2) {
    // "실수의 대소 관계"에서 "실수" 매칭: "실수"로 시작하고 뒤에 조사/공백이 오는 경우
    const idx = tLower.indexOf(gLower);
    if (idx === -1) return false;
    // 시작 위치이거나 앞이 공백인 경우만
    if (idx !== 0 && tLower[idx - 1] !== ' ') return false;
    // 뒤에 아무것도 없거나 조사("의", "와", "과", "에", " ")가 오는 경우
    const afterIdx = idx + gLower.length;
    if (afterIdx >= tLower.length) return true;
    const nextChar = tLower[afterIdx];
    return ['의', '와', '과', '에', ' ', '·', ',', '('].includes(nextChar);
  }

  // 3글자 이상이면 부분 문자열 매칭 허용
  return tLower.includes(gLower) || gLower.includes(tLower);
}

/**
 * 시험 결과 기반 수준 추정
 * @param correctRate 정답률 (0~100)
 */
export function estimateLevel(correctRate: number): '하위권' | '중위권' | '상위권' {
  if (correctRate >= 80) return '상위권';
  if (correctRate >= 50) return '중위권';
  return '하위권';
}

/**
 * 학년 기반 멘트 필터링 (중학생/고등학생 맞춤)
 * @param messages 원본 멘트 배열
 * @param grade 학년 (예: '중1', '고2')
 */
export function filterMessagesByGrade(messages: string[], grade: string): string[] {
  const isMiddleSchool = grade.startsWith('중');

  return messages.map(msg => {
    // 고등학교 관련 멘트를 중학생에게 맞게 수정
    if (isMiddleSchool) {
      return msg
        .replace(/고등학교 3년/g, '중고등학교 시절')
        .replace(/고등학교 수학/g, '고등학교 진학 후 수학')
        .replace(/대학/g, '고등학교')
        .replace(/수능/g, '고입/내신');
    }
    return msg;
  });
}
